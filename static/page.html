<!DOCTYPE html>
<html>
<body>
        
    
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootswatch/4.3.1/darkly/bootstrap.min.css">

<style>     
    .border {
    border-width:4px !important;
    border-style: outset !important;
    }
    .border-pink{
        border-color: rgb(255,0,204) !important;
    }
</style>

<div class="container-fluid">
    <div id = "metadata" class= "text-center p-3 h3"></div>
    <div class = "row pt-4">
        <div class="pl-5 pr-4 col-md-4" id = "col1">
            <div id = "type_list"></div>
        </div>
        
        <div class="pr-4 pl-4 col-md-4" id = "col2">
            <div id = "group_list"></div>
        </div>

        <div class="pr-5 pl-4 col-md-4" id = "col3">
            <div id = "cat_list"></div>
        </div>
    </div>
</div>
<script>
    var scandata
    var url = window.location.href
    var urlsplit = url.split("/").slice(-1)[0]; //get last part of document URL
    var hostname = window.location.hostname
    $(document).ready(function(){ //wait for page to load
        // first we call getships(), when get ships is done it calls get groups(), when get groups is done it calls renderview(). This is done to ensure all static data is loaded before rendering the data
        getships()
        function getships() {
            $.getJSON("http://" + hostname + ":5000/data/ships.json").then(function(response){
                dpsShips = response['dpsShips']
                logiShips = response['logiShips']
                supportShips = response['supportShips']
                cynoShips = response['cynoShips']
                capShips = response['caps']
                superShips = response['supers']
                faxShips = response['faxes']
                titanShips = response['titans']
                getgroups()
                })
        }   
        function getgroups() {
            $.getJSON("http://" + hostname + ":5000/data/groups.json").then(function(response){
                dps = response['dps']
                support = response['support']
                cyno = response['cyno']
                logi = response['logi']
                caps = response['caps']
                supers = response['supers']
                faxes = response['faxes']
                titans = response['titans']
                renderview()
            })            
        }
        function renderview() { 
            $.getJSON("http://" + hostname + ":5000/api/scan/" + urlsplit, function(response) { //get scan data using last part of current URL
                var typearray = []
                var typecount = 0
                document.getElementById("metadata").innerHTML =  "System: " + response['system']
                for (const [key, value] of Object.entries(response['typelist'])){ //convert dict to array of objects
                    //passing the key name directly to an object doesnt work, this is a workaround for this
                    var obj = {}
                    obj[key] = value
                    typecount += value
                    // assign class for later highlighting, the letter at the start is for sorting purposes.
                    if (dpsShips.includes(key) == true){
                        obj["class"] = "A_dps"
                    }
                    else if (logiShips.includes(key) == true){
                        obj["class"] = "B_logi"
                    }
                    else if (supportShips.includes(key) == true){
                        obj["class"] = "C_support"
                    }
                    else if (cynoShips.includes(key) == true){
                        obj["class"] = "D_cyno"
                    }
                    else if (titanShips.includes(key) == true){
                        obj["class"] = "E_titan"
                    }
                    else if (superShips.includes(key) == true){
                        obj["class"] = "F_super"
                    }
                    else if (faxShips.includes(key) == true){
                        obj["class"] = "G_fax"
                    }
                    else if (capShips.includes(key) == true){
                        obj["class"] = "H_cap"
                    }
                    else{
                        obj["class"] = "I_none"
                    }
                    typearray.push(obj)
                }
                var grouparray = []
                var groupcount = 0
                for (const [key, value] of Object.entries(response['grouplist'])){ //convert dict to array of objects
                    var obj = {}
                    obj[key] = value
                    groupcount += value
                    // assign class for later highlighting, the letter at the start is for sorting purposes.
                    if (dps.includes(key) == true){
                        obj["class"] = "A_dps"
                    }
                    else if (logi.includes(key) == true){
                        obj["class"] = "B_logi"
                    }
                    else if (support.includes(key) == true){
                        obj["class"] = "C_support"
                    }
                    else if (cyno.includes(key) == true){
                        obj["class"] = "D_cyno"
                    }
                    else if (titans.includes(key) == true){
                        obj["class"] = "E_titan"
                    }
                    else if (supers.includes(key) == true){
                        obj["class"] = "F_super"
                    }
                    else if (faxes.includes(key) == true){
                        obj["class"] = "G_fax"
                    }
                    else if (caps.includes(key) == true){
                        obj["class"] = "H_cap"
                    }
                    else{
                        obj["class"] = "I_none"
                    }
                    grouparray.push(obj)
                    
                }
                var catarray = []
                var catcount = 0
                for (const [key, value] of Object.entries(response['catlist'])){ //convert dict to array of objects
                    var obj = {}
                    obj[key] = value
                    catcount += value
                    obj["class"] = "E_none" //no highlighting for categories
                    catarray.push(obj)
                }
    

                //sort lists by first key alphabetically
                typearray.sort((a, b) => (Object.keys(a)[0] < Object.keys(b)[0]) ? 1 : -1)
                grouparray.sort((a, b) => (Object.keys(a)[0] < Object.keys(b)[0]) ? 1 : -1)
                catarray.sort((a, b) => (Object.keys(a)[0] < Object.keys(b)[0]) ? 1 : -1)
                //sort lists by entry amount
                typearray.sort((a, b) => (a[Object.keys(a)[0]] < b[Object.keys(b)[0]]) ? 1 : -1)
                grouparray.sort((a, b) => (a[Object.keys(a)[0]] < b[Object.keys(b)[0]]) ? 1 : -1)
                catarray.sort((a, b) => (a[Object.keys(a)[0]] < b[Object.keys(b)[0]]) ? 1 : -1)
                //sort lists alphabetically by class type
                typearray.sort((a, b) => (a[Object.keys(a)[1]] > b[Object.keys(b)[1]]) ? 1 : -1)
                grouparray.sort((a, b) => (a[Object.keys(a)[1]] > b[Object.keys(b)[1]]) ? 1 : -1)
                //catarray.sort((a, b) => (Object.keys(a)[1] < Object.keys(b)[1]) ? 1 : -1)
                document.getElementById('type_list').appendChild(makeUL(typearray)) //call function to make unorderd list
                document.getElementById('group_list').appendChild(makeUL(grouparray)) //call function to make unorderd list
                document.getElementById('cat_list').appendChild(makeUL(catarray)) //call function to make unorderd list

            })
        };
    });

    function makeUL(array) { //here we crate the lists that go into the columns (type, group, category) and colour them for easier reading
        var list = document.createElement('ul')
        list.className = 'list-group'
        array.forEach(function(dict){
            var key = Object.keys(dict)[0] //extract the key of the first entry
            var value = dict[Object.keys(dict)[0]] //extract the value of the first entry
            var classtype = dict[Object.keys(dict)[1]] //extract the value of the second entry`
            var item = document.createElement('li') // create list element
            item.className = 'list-group-item d-flex justify-content-between align-items-center' //add classnames to list element (for css)
            var badgeitem = document.createElement('span') //create badge element
            if (classtype == "A_dps"){ //check class type and assign background colours accordingly
                badgeitem.className = 'badge badge-primary badge-pill float-right bg-danger' // add classnames (for css)
            }
            else if (classtype == "C_support"){
                badgeitem.className = 'badge badge-primary badge-pill float-right bg-warning' // add classnames (for css)
            }
            else if (classtype == "B_logi"){
                badgeitem.className = 'badge badge-primary badge-pill float-right bg-success' // add classnames (for css)
            }
            else if (classtype == "D_cyno"){
                badgeitem.className = 'badge badge-primary badge-pill float-right bg-info' // add classnames (for css)
            }
            /*
            else if (classtype == "F_super"){
                badgeitem.className = 'badge badge-primary badge-pill float-right bg-info' // add classnames (for css)
            }
            else if (classtype == "G_fax"){
                badgeitem.className = 'badge badge-primary badge-pill float-right bg-success' // add classnames (for css)
            }
            else if (classtype == "H_cap"){
                badgeitem.className = 'badge badge-primary badge-pill float-right bg-warning' // add classnames (for css)
            }
            else if (classtype =="I_none"){ 
                badgeitem.className = 'badge badge-primary badge-pill float-right' // add classnames (for css)
            }
            */
            else{ 
                badgeitem.className = 'badge badge-primary badge-pill float-right' // add classnames (for css)
            }
            if (classtype == "E_titan"){
                item.className = 'list-group-item border border-pink     rounded d-flex justify-content-between align-items-center' // add classnames (for css)
            }
            else if (classtype == "F_super"){
                item.className = 'list-group-item border border-danger     rounded d-flex justify-content-between align-items-center' // add classnames (for css)
            }
            else if (classtype == "G_fax"){
                item.className = 'list-group-item border border-success rounded d-flex justify-content-between align-items-center' // add classnames (for css)
            }
            else if (classtype == "H_cap"){
                item.className = 'list-group-item border border-warning d-flex justify-content-between align-items-center' // add classnames (for css)
            }
            else{
                item.className = 'list-group-item d-flex justify-content-between align-items-center' //add classnames to list element (for css)
            }
            /*
            else if (classtype == "I_None"){
                item.className = 'list-group-item d-flex justify-content-between align-items-center' //add classnames to list element (for css)
            }
            */
            badgeitem.appendChild(document.createTextNode(value)) //add text node to badge element
            item.appendChild(document.createTextNode(key)) //add text note to list element
            item.appendChild(badgeitem) //add the bage element to the list element
            list.appendChild(item) //add the list element to the list
        })
        return list
    }
</script>

</body>
</html> 
